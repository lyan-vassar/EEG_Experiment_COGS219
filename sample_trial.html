<!DOCTYPE html>
<html>

<head>
    <title>Hemispheric Asymmetries and Joke Comprehension</title>
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/plugin-html-keyboard-response.js"></script>
    <script src="jspsych/plugin-preload.js"></script>
    <script src="jspsych/plugin-survey-text.js"></script>

    <script src="jokes1.js"></script>

    <!-- stylesheet from the library-->
    <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />

    <style>
        .jspsych-display-element {
            font-size: 60px;
            font-family: "Helvetica", Arial;
        }
    </style>

</head>

<body></body>
<style></style>

<script>

    //We initialize the JsPsych here
    var jsPsych = initJsPsych({
        //we dont need audio so we disabled it
        use_webaudio: false,
        //I want to see how the data looks like when the experiment is over
        //so I include this function to see the data "on_finish"
        on_finish: function () {
            jsPsych.data.displayData();
        }
    });

    var urlvar = jsPsych.data.urlVariables();
    //decides which list is going to be used, either 0, 1, 2, 3.
    var selectedNumber = urlvar.list;
    console.log(test_stimuli[selectedNumber]);


    //This is the timeline where we will add all the javascript variables
    //(the trials and instrucitons and whatnot) so they can appear on the
    //screen in chronological order
    var timeline = []; //it is a variable and it is initialized as an empty list 

    //we choose to preload all the data, whether it be audio, pictures, or
    //text data beforehand so that the experiment does not lag in run time
    var preload = {
        type: jsPsychPreload,
        auto_preload: true
    }

    // researcher input
    var researchInput = {
        type: jsPsychSurveyText,
        questions: [
            { prompt: "Participant ID: ", required: true },
            { prompt: "List #", required: true }
        ],
        on_finish: function (data) {
            list_ID = data.response.Q1;
            if (list_ID >= 1 && list_ID <= 4) {
                test_procedure["timeline_variables"] = test_stimuli[selectedNumber];
            }
            else {
                listID = jsPsych.randomization.randomInt(0, 3);
                test_procedure["timeline_variables"] = test_stimuli[selectedNumber];
            }
        }
    }

    timeline.push(researchInput);

    //welcome message
    var welcome = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "Welcome to our EEG Experiment. Press any key to begin."
    }

    timeline.push(welcome);

    //initialize the joke sentence and the words
    var joke = "";
    var joke_words = [];
    //initialize the counter
    var i = 0;

    var fixation = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "+",
        choices: "NO_KEYS",
        trial_duration: 2000,
        on_finish: function () {
            joke = jsPsych.timelineVariable("Joke stem")
            joke_words = joke.split(" ")
        }
    }

    var joke_loop = {
        timeline: [{
            type: jsPsychHtmlKeyboardResponse,
            stimulus: function () {
                return joke_words[i];
            },
            choices: "NO_KEYS",
            trial_duration: function () {
                //from the pair
                return 200 + (32 * joke_words[i].length);
            }
        }],

        loop_function: function () {
            i++;
            if (i < joke_words.length) {
                return true;
            } else {
                joke = "";
                joke_words = [];
                i = 0;
                return false;
            }
        }
    }

    // var num_of_trials = 60

    // const array0 = new Array(num_of_trials / 2).fill(false);
    // const array1 = new Array(num_of_trials / 2).fill(true);
    // var left_right_array = array0.concat(array1);
    // left_right_array = jsPsych.randomization.shuffle(left_right_array);
    // var lr = 0;

    var test = {
        on_load: () => {
            fetch(
                `http://127.0.0.1:8000/trigger/tcp/${jsPsych.timelineVariable(
                    "trigger_value"
                )}`
            );
        },

        type: jsPsychHtmlKeyboardResponse,
        stimulus: function () {
            var left_right_choice = jsPsych.timelineVariable("left_or_right");

            var leftEnding = `<div style="position:relative; width:800px; height:60px; line-height:60px">
                <p style="position:absolute; width:800px; text-align:center; margin:0;">+</p>
                <p style="position:absolute; left: calc(50% + 89px); margin:0;">${jsPsych.timelineVariable("Ending")}</p>
                </div>`

            var rightEnding = `<div style="position:relative; width:800px; height:60px; line-height:60px;">
                <p style="position:absolute; width:800px; text-align:center; margin:0;">+</p>
                <p style="position:absolute; right:calc(50% + 89px); margin:0;">${jsPsych.timelineVariable("Ending")}</p>
                </div>`

            if (left_or_right_choice = "left") {
                return leftEnding;
            }
            else {
                return rightEnding;
            }
        },

        choices: "NO_KEYS",
        trial_duration: 1000,
        post_trial_gap: 2500
    }

    var question_mark = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "<div style='color:blue;'>?</div>",
        choices: "NO_KEYS",
        trial_duration: 2000,
    }

    var question = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: jsPsych.timelineVariable("Question"),
        choices: jsPsych.timelineVariable("Correct_Response"),

        //THIS IS WHERE WE STORE THE DATA
        
        data: {
            task: "response",
            id: jsPsych.timelineVariable("Id"),
            sentence: jsPsych.timelineVariable("Sentence"),
            ending: jsPsych.timelineVariable("Ending"),
            left_or_right: jsPsych.timelineVariable("left_or_right"),

            type: jsPsych.timelineVariable("Type"),
            question: jsPsych.timelineVariable("Question"),
            correct_response: jsPsych.timelineVariable("Correct_Response"),



        },
        //trial_duration: 4000,
        on_finish: function (data) {
            data.correct = jsPsych.pluginAPI.compareKeys(data.response, data.correct_response)
            // if not case sensitive can just use: 
            //"data.correct = data.response === data.correct_response;"
        },
        post_trial_gap: 2000
    }

    var test_procedure = {
        timeline: [fixation, joke_loop, test, question_mark, question],
        timeline_variables: test_stimuli[selectedNumber],
    }


    timeline.push(test_procedure);

    var debrief_block = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function () {
            var trials = jsPsych.data.get().filter({ task: "response" });
            var correct_trials = trials.filter({ correct: true });
            var accuracy = Math.round(correct_trials.count() / trials.count() * 100);
            //var rt = Math.round(correct_trials.select("rt").mean());

            return `<p>You responded correctly on ${accuracy}% of the trials.</p> <p>Press any key to complete the experiment. Thank you!</p>`;
        }
    }

    timeline.push(debrief_block);

    jsPsych.run(timeline);

</script>

</html>