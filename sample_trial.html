<!DOCTYPE html>
<html>

<head>
    <title>Hemispheric Asymmetries and Joke Comprehension</title>
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/plugin-html-keyboard-response.js"></script>
    <script src="jspsych/plugin-preload.js"></script>

    <script src="jokes2.js"></script>

    <!-- stylesheet from the library-->
    <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />

    <style>
        .jspsych-display-element {
            font-size: 60px;
            font-family: "Helvetica", Arial;
        }
    </style>

</head>

<body></body>
<style></style>

<script>

    //We initialize the JsPsych here
    var jsPsych = initJsPsych({
        //we dont need audio so we disabled it
        use_webaudio: false,
        //I want to see how the data looks like when the experiment is over
        //so I include this function to see the data "on_finish"
        on_finish: function () {
            jsPsych.data.displayData();
        }
    });

    //This is the timeline where we will add all the javascript variables
    //(the trials and instrucitons and whatnot) so they can appear on the
    //screen in chronological order
    var timeline = []; //it is a variable and it is initialized as an empty list 

    //we choose to preload all the data, whether it be audio, pictures, or
    //text data beforehand so that the experiment does not lag in run time
    var preload = {
        type: jsPsychPreload,
        auto_preload: true
    }

    //welcome message
    var welcome = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "Welcome to our EEG Experiment. Press any key to begin."
    }

    timeline.push(welcome);

    //initialize the joke sentence and the words
    var joke = "";
    var joke_words = [];
    //initialize the counter
    var i = 0;

    var fixation = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "+",
        choices: "NO_KEYS",
        trial_duration: 2000,
        on_finish: function () {
            joke = jsPsych.timelineVariable("Joke stem")
            joke_words = joke.split(" ")
        }
    }

    var joke_loop = {
        timeline: [{
            type: jsPsychHtmlKeyboardResponse,
            stimulus: function () {
                return joke_words[i];
            },
            choices: "NO_KEYS",
            trial_duration: function () {
                //from the pair
                return 200 + (32 * joke_words[i].length);
            }
        }],

        loop_function: function () {
            i++;
            if (i < joke_words.length) {
                return true;
            } else {
                joke = "";
                joke_words = [];
                i = 0;
                return false;
            }
        }
    }


    /* Randomize array in-place using Durstenfeld shuffle algorithm */
    //Found online and utilized here:)
    function shuffleArray(array) {
        for (var i = array.length - 1; i > 0; i--) {
            var j = Math.floor(Math.random() * (i + 1));
            var temp = array[i];
            array[i] = array[j];
            array[j] = temp;
        }
    }

    var num_of_trials = 60
    const array0 = new Array(num_of_trials / 2).fill(false);
    const array1 = new Array(num_of_trials / 2).fill(true);
    var left_right_array = array0.concat(array1);
    shuffleArray(left_right_array);
    var left_or_right = 0;
    var index = 0;

    var test = {
        on_start: function () {
            left_or_right = left_right_array[index];
            index++;
        },
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function () {
            var rand_choice = jsPsych.randomization.randomInt(0, 1);
            console.log(rand_choice);
            var returnRightJoke = `<div
            style="position: fixed;
                               left: 50%;
                               top: 50%;
                               transform: translate(-50%, -50%);">+</div>

                        <div style="transform: translateX(5em);">${jsPsych.timelineVariable("Joke ending")}</div>`

            var returnRightNonjoke = `<div
            style="position: fixed;
                               left: 50%;
                               top: 50%;
                               transform: translate(-50%, -50%);">+</div>

                        <div style="transform: translateX(5em);">${jsPsych.timelineVariable("Nonjoke ending")}</div>`
            var returnLeftJoke = `<div
            style="position: fixed;
                               left: 50%;
                               top: 50%;
                               transform: translate(-50%, -50%);">+</div>

                        <div style="transform: translateX(-5em);">${jsPsych.timelineVariable("Joke ending")}</div>`
            var returnLeftNonjoke = `<div
            style="position: fixed;
                               left: 50%;
                               top: 50%;
                               transform: translate(-50%, -50%);">+</div>

                        <div style="transform: translateX(-5em);">${jsPsych.timelineVariable("Nonjoke ending")}</div>`

            if (left_or_right) {
                if (rand_choice == 0) {
                    return returnRightJoke;
                } else {
                    return returnRightNonjoke;
                }
            }
            else {
                if (rand_choice == 1) {
                    return returnLeftJoke;
                } else {
                    return returnLeftNonjoke;
                }
            }
        },

        choices: "NO_KEYS",
        trial_duration: 1000,
        post_trial_gap: 2500
    }

    var question_mark = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "<div style='color:blue;'>?</div>",
        choices: "NO_KEYS",
        trial_duration: 2000,
    }

    var question = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function () {
            var rand_choice = jsPsych.randomization.randomInt(0, 1);
            if (rand_choice == 0) {
                return jsPsych.timelineVariable("JokeQuestion");
            } else {
                return jsPsych.timelineVariable("NonjokeQuestion");
            }
        },
        choices: ["y", "n"],
        data: {
            task: "response",
            correct_response: jsPsych.timelineVariable("correct_response")
        },
        //trial_duration: 4000,
        on_finish: function (data) {
            data.correct = jsPsych.pluginAPI.compareKeys(data.response, data.correct_response)
            // if not case sensitive can just use: 
            //"data.correct = data.response === data.correct_response;"
        },
        post_trial_gap: 2000
    }

    var test_procedure = {
        timeline: [fixation, joke_loop, test, question_mark, question],
        timeline_variables: test_stimuli,
        randomize_order: true
    }

    timeline.push(test_procedure);

    var debrief_block = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function () {
            var trials = jsPsych.data.get().filter({ task: "response" });
            var correct_trials = trials.filter({ correct: true });
            var accuracy = Math.round(correct_trials.count() / trials.count() * 100);
            //var rt = Math.round(correct_trials.select("rt").mean());

            return `<p>You responded correctly on ${accuracy}% of the trials.</p> <p>Press any key to complete the experiment. Thank you!</p>`;
        }
    }

    timeline.push(debrief_block);

    jsPsych.run(timeline);

</script>

</html>