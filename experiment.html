<!DOCTYPE html>
<html>

<head>
    <title>Hemispheric Asymmetries and Joke Comprehension</title>
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/plugin-fullscreen.js"></script>
    <script src="jspsych/plugin-html-keyboard-response.js"></script>
    <script src="jspsych/plugin-preload.js"></script>
    <script src="jspsych/plugin-survey-text.js"></script>

    <script src="trial11.js"></script>
    <script src="practice.js"></script>

    <!-- stylesheet from the library-->
    <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />

    <style>
        .big-font {
            font-size: 60px;
            font-family: "Helvetica", Arial;
        }
    </style>

</head>

<body></body>
<style></style>

<script>
    var jsPsych = initJsPsych({});

    var urlvar = jsPsych.data.urlVariables();
    //decides which list is going to be used, either 0, 1, 2, 3.
    var selectedNumber = urlvar.list;
    
    //This is the timeline where we will add all the javascript variables
    //(the trials and instrucitons and whatnot) so they can appear on the
    //screen in chronological order
    var timeline = []; //it is a variable and it is initialized as an empty list 

    // researcher input
    var researchInput = {
        type: jsPsychSurveyText,
        questions: [
            {prompt: "Participant ID: ", required: true},
            {prompt: "List #", required: true}
        ],
        on_finish: function(data) {
            list_ID = data.response.Q1;
            if (list_ID >= 1 && list_ID <= 4) {
                test_procedure["timeline_variables"] = test_stimuli[selectedNumber];
            }
            else {
                listID = jsPsych.randomization.randomInt(0, 3);
                test_procedure["timeline_variables"] = test_stimuli[selectedNumber];
            }
        }
    }

    timeline.push(researchInput);

    var enter_fullscreen = {
        type: jsPsychFullscreen,
        fullscreen_mode: true
    }

    timeline.push(enter_fullscreen);

    // welcome message
    var welcome = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "Welcome to our EEG Experiment. Press any key to begin."
    }

    timeline.push(welcome);

     // practice block

     var practice_instructions = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "We will now begin the practice portion of the experiment. Press any key to begin."
    }

    var practice_sentence = "";
    var practice_words = [];
    //initialize the counter
    var i = 0;

    var practice_fixation = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "+",
        choices: "NO_KEYS",
        trial_duration: 2000,
        on_finish: function () {
            practice_sentence = jsPsych.timelineVariable("Sentence")
            practice_words = practice_sentence.split(" ")
        }
    }

    var practice_loop = {
        timeline: [{
            type: jsPsychHtmlKeyboardResponse,
            stimulus: function () {
                return practice_words[i];
            },
            choices: "NO_KEYS",
            trial_duration: function () {
                //from the pair
                return 200 + (32 * practice_words[i].length);
            }
        }],

        loop_function: function () {
            i++;
            if (i < practice_words.length) {
                return true;
            } else {
                practice_sentence = "";
                practice_words = [];
                i = 0;
                return false;
            }
        }
    }

    var practice_trial = {
        on_load: () => {
            fetch(
                `http://127.0.0.1:8000/trigger/tcp/${jsPsych.timelineVariable(
                    "trigger_value"
                )}`
            );
        },
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function () {
            if (jsPsych.timelineVariable("Left_or_Right") == "left") {
                var ending = `<div style="position:relative; width:800px; height:60px; line-height:60px;">
                <p style="position:absolute; width:800px; text-align:center; margin:0;">+</p>
                <p style="position:absolute; right:calc(50% + 89px); margin:0;">${jsPsych.timelineVariable("Completion")}</p>
                </div>`;
            }
            else {
                var ending = `<div style="position:relative; width:800px; height:60px; line-height:60px;">
                <p style="position:absolute; width:800px; text-align:center; margin:0;">+</p>
                <p style="position:absolute; left:calc(50% + 89px); margin:0;">${jsPsych.timelineVariable("Completion")}</p>
                </div>`;
            }
            return ending;
        },

        choices: "NO_KEYS",
        trial_duration: 1000,
        post_trial_gap: 2500
    }

    var question_mark = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "<div style='color:blue;'>?</div>",
        choices: "NO_KEYS",
        trial_duration: 2000,
    }

    var practice_question = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: jsPsych.timelineVariable("Question"),
        choices: ["y", "n"],
        data: {
            task: "response",
            correct_response: jsPsych.timelineVariable("Correct_Response")
        },
        //trial_duration: 4000,
        on_finish: function (data) {
            data.correct = jsPsych.pluginAPI.compareKeys(data.response, data.correct_response)
            // if not case sensitive can just use: 
            //"data.correct = data.response === data.correct_response;"
        },
        post_trial_gap: 2000
    }

    var intermission = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "Please wait for the researcher to enter the room."
    }

    var ask_to_repeat = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "Would you like to repeat the practice session? Press 'y' for yes, and 'n' for no.",
        choices: ["y", "n"],
        data: {
            task: "repeat"
        }
    }

    var loop_node = {
        timeline: [practice_instructions, practice_fixation, practice_loop, practice_trial, 
                    question_mark, practice_question, intermission, ask_to_repeat],
        loop_function: function(data){
            if(jsPsych.pluginAPI.compareKeys(data.filter({task:"repeat"}).values()[0].response, "y")){
                return true;
            } else {
                return false;
            }
        }
    }

    var practice_procedure = {
        timeline: [loop_node],
        timeline_variables: practice_questions
    }

    timeline.push(practice_procedure);

    //timeline.push(ask_to_repeat, if_node);

    var beginning_exp = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "We will now begin the experiment. Press any key to begin."
    }

    timeline.push(beginning_exp);

    // STARTING EXPERIMENT
    //initialize the joke sentence and the words
    var joke = "";
    var joke_words = [];
    //initialize the counter
    var i = 0;

    var fixation = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "+",
        choices: "NO_KEYS",
        trial_duration: 2000,
        on_finish: function () {
            joke = jsPsych.timelineVariable("Sentence")
            joke_words = joke.split(" ")
        }
    }

    var joke_loop = {
        timeline: [{
            type: jsPsychHtmlKeyboardResponse,
            stimulus: function () {
                return joke_words[i];
            },
            choices: "NO_KEYS",
            trial_duration: function () {
                //from the pair
                return 200 + (32 * joke_words[i].length);
            }
        }],

        loop_function: function () {
            i++;
            if (i < joke_words.length) {
                return true;
            } else {
                joke = "";
                joke_words = [];
                i = 0;
                return false;
            }
        }
    }

    // var num_of_trials = 60

    // const array0 = new Array(num_of_trials / 2).fill(false);
    // const array1 = new Array(num_of_trials / 2).fill(true);
    // var left_right_array = array0.concat(array1);
    // left_right_array = jsPsych.randomization.shuffle(left_right_array);
    // var lr = 0;

    var test = {
        on_load: () => {
            fetch(
                `http://127.0.0.1:8000/trigger/tcp/${jsPsych.timelineVariable(
                    "trigger_value"
                )}`
            );
        },

        type: jsPsychHtmlKeyboardResponse,
        stimulus: function () {
            var left_right_choice = jsPsych.timelineVariable("left_or_right");

            var leftEnding = `<div style="position:relative; width:800px; height:60px; line-height:60px">
                <p style="position:absolute; width:800px; text-align:center; margin:0;">+</p>
                <p style="position:absolute; left: calc(50% + 89px); margin:0;">${jsPsych.timelineVariable("Ending")}</p>
                </div>`

            var rightEnding = `<div style="position:relative; width:800px; height:60px; line-height:60px;">
                <p style="position:absolute; width:800px; text-align:center; margin:0;">+</p>
                <p style="position:absolute; right:calc(50% + 89px); margin:0;">${jsPsych.timelineVariable("Ending")}</p>
                </div>`

            if (left_or_right_choice = "left") {
                return leftEnding;
            }
            else {
                return rightEnding;
            }
        },

        choices: "NO_KEYS",
        trial_duration: 1000,
        post_trial_gap: 2500
    }

    var question_mark = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "<div style='color:blue;'>?</div>",
        choices: "NO_KEYS",
        trial_duration: 2000,
    }

    var question = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: jsPsych.timelineVariable("Question"),
        choices: jsPsych.timelineVariable("Correct_Response"),

        //THIS IS WHERE WE STORE THE DATA
        
        data: {
            task: "response",
            id: jsPsych.timelineVariable("Id"),
            sentence: jsPsych.timelineVariable("Sentence"),
            ending: jsPsych.timelineVariable("Ending"),
            left_or_right: jsPsych.timelineVariable("Left_or_Right"),

            type: jsPsych.timelineVariable("Sentence_Type"),
            question: jsPsych.timelineVariable("Question"),
            correct_response: jsPsych.timelineVariable("Correct_Response"),



        },
        //trial_duration: 4000,
        on_finish: function (data) {
            data.correct = jsPsych.pluginAPI.compareKeys(data.response, data.correct_response)
            // if not case sensitive can just use: 
            //"data.correct = data.response === data.correct_response;"
        },
        post_trial_gap: 2000
    }

    var test_procedure = {
        timeline: [fixation, joke_loop, test, question_mark, question],
        timeline_variables: test_stimuli[selectedNumber],
    }


    timeline.push(test_procedure);

    

    var debrief_block = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function () {
            var trials = jsPsych.data.get().filter({ task: "response" });
            var correct_trials = trials.filter({ correct: true });
            var accuracy = Math.round(correct_trials.count() / trials.count() * 100);
            //var rt = Math.round(correct_trials.select("rt").mean());

            return `<p>You responded correctly on ${accuracy}% of the trials.</p> <p>Press any key to complete the experiment. Thank you!</p>`;
        }
    }

    timeline.push(debrief_block);

    var exit_fullscreen = {
        type: jsPsychFullscreen,
        fullscreen_mode: false
    }

    timeline.push(exit_fullscreen);

    jsPsych.run(timeline);

</script>

</html>